pipeline {
  agent any
  options { timestamps() }

  environment {
    // --- app & docker metadata (asli dari user)
    APP_NAME           = 'BoF.Careers'              // nama tampilan
    DOCKER_HUB_USER    = 'auliaanrhm'
    DOCKER_TAG         = 'latest'
    DOCKER_CREDENTIALS = 'dockerhub-credentials'    // id credentials di Jenkins
    // DOCKER_IMAGE akan diisi di stage Init (dibikin slug yg valid)
  }

  stages {
    stage('Init') {
      steps {
        script {
          // slug aman untuk image & COMPOSE_PROJECT_NAME:
          // - lowercase
          // - semua non [a-z0-9] jadi '-'
          // - trim '-' di awal/akhir
          env.APP_SLUG = env.APP_NAME.toLowerCase()
                                   .replaceAll('[^a-z0-9]+','-')
                                   .replaceAll('(^-|-$)','')

          env.DOCKER_IMAGE = "${env.DOCKER_HUB_USER}/${env.APP_SLUG}:${env.DOCKER_TAG}"
          env.COMPOSE_PROJECT_NAME = env.APP_SLUG
        }
        echo "üîß APP_NAME             = ${env.APP_NAME}"
        echo "üîß APP_SLUG             = ${env.APP_SLUG}"
        echo "üîß DOCKER_IMAGE         = ${env.DOCKER_IMAGE}"
        echo "üîß COMPOSE_PROJECT_NAME = ${env.COMPOSE_PROJECT_NAME}"
      }
    }

    stage('Checkout') {
      steps {
        echo "üì• Checkout ${env.APP_NAME}‚Ä¶"
        git branch: 'main', url: 'https://github.com/auliaanrhm/uas_fp-main.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        echo "üê≥ Build image %DOCKER_IMAGE%"
        bat  'docker build -t %DOCKER_IMAGE% .'
      }
    }

    stage('Push to Docker Hub') {
      steps {
        echo "üì§ Push %DOCKER_IMAGE%"
        withCredentials([usernamePassword(
          credentialsId: env.DOCKER_CREDENTIALS,
          usernameVariable: 'USER',
          passwordVariable: 'PASS'
        )]) {
          bat 'docker login -u %USER% -p %PASS%'
          bat 'docker push %DOCKER_IMAGE%'
        }
      }
    }

    stage('Run Docker Compose') {
      steps {
        echo 'üöÄ docker compose up'
        // pakai slug supaya nama network/container valid
        bat 'set COMPOSE_PROJECT_NAME=%COMPOSE_PROJECT_NAME% && docker compose down --remove-orphans'
        bat 'set COMPOSE_PROJECT_NAME=%COMPOSE_PROJECT_NAME% && docker compose up -d --build'
      }
    }
  }

  post {
    success { echo '‚úÖ Pipeline finished successfully!' }
    failure { echo '‚ùå Pipeline failed.' }
  }
}

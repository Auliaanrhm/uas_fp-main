pipeline {
  agent any

  environment {
    APP_NAME           = 'bof-careers'
    DOCKER_HUB_USER    = 'auliaanrhm'
    DOCKER_TAG         = 'latest'
    DOCKER_IMAGE       = "${DOCKER_HUB_USER}/${APP_NAME}:${DOCKER_TAG}"
    DOCKER_CREDENTIALS = 'dockerhub-credentials'
  }

  stages {
    stage('Checkout') {
      steps {
        echo "üì• Checkout ${env.APP_NAME}‚Ä¶"
        git branch: 'main', url: 'https://github.com/auliaanrhm/uas_fp-main.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        echo "üê≥ Build image ${env.DOCKER_IMAGE}"
        bat  'docker build -t %DOCKER_IMAGE% .'
      }
    }

    stage('Push to Docker Hub') {
      steps {
        echo "üì§ Push ${env.DOCKER_IMAGE}"
        withCredentials([usernamePassword(
          credentialsId: env.DOCKER_CREDENTIALS,
          usernameVariable: 'USER',
          passwordVariable: 'PASS'
        )]) {
          bat 'docker login -u %USER% -p %PASS%'
          bat 'docker push %DOCKER_IMAGE%'
        }
      }
    }

    stage('Run Docker Compose') {
      steps {
        echo 'üöÄ docker compose up'
        powershell '''
          "db","phpmyadmin","app" | ForEach-Object {
            try { docker rm -f $_ | Out-Null } catch {}
          }
        '''
        bat 'set "COMPOSE_PROJECT_NAME=%APP_NAME%" && docker compose down -v --remove-orphans'
        bat 'set "COMPOSE_PROJECT_NAME=%APP_NAME%" && docker compose up -d --build'
      }
    }
  }

  post {
    success { echo '‚úÖ Pipeline finished successfully!' }
    failure { echo '‚ùå Pipeline failed.' }
  }
}
